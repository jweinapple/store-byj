<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printful API Demo - byJ.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">Printful API Integration Demo</h1>
        
        <!-- Products Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">1. Fetch Products</h2>
            <button id="fetch-products-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 mb-4">
                <i class="fas fa-download mr-2"></i>Fetch Products from Printful
            </button>
            <div id="products-result" class="mt-4"></div>
        </div>

        <!-- Mockup Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">2. Generate Mockup</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Variant ID:</label>
                    <input type="text" id="variant-id" placeholder="e.g., 4011" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Image URL (for design):</label>
                    <input type="url" id="image-url" placeholder="https://example.com/design.png" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <button id="create-mockup-btn" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                    <i class="fas fa-image mr-2"></i>Create Mockup
                </button>
                <div id="mockup-result" class="mt-4"></div>
            </div>
        </div>

        <!-- Order Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">3. Estimate Shipping</h2>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Country Code:</label>
                        <input type="text" id="country-code" placeholder="US" value="US" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">State Code:</label>
                        <input type="text" id="state-code" placeholder="CA" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Variant ID:</label>
                    <input type="text" id="shipping-variant-id" placeholder="4011" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <button id="estimate-shipping-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                    <i class="fas fa-shipping-fast mr-2"></i>Estimate Shipping
                </button>
                <div id="shipping-result" class="mt-4"></div>
            </div>
        </div>
    </div>

    <script>
        // API Helper Functions
        async function fetchProducts() {
            try {
                const response = await fetch('/api/printful-products');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }

        async function createMockup(variantId, imageUrl) {
            try {
                const response = await fetch('/api/printful-mockup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        variant_ids: [parseInt(variantId)],
                        files: [{
                            url: imageUrl
                        }],
                        format: 'jpg',
                        width: 1000
                    })
                });
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }

        async function getMockupStatus(taskKey) {
            try {
                const response = await fetch(`/api/printful-mockup?task_key=${taskKey}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }

        async function estimateShipping(countryCode, stateCode, variantId) {
            try {
                const response = await fetch('/api/printful-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'estimate_shipping',
                        shipping_data: {
                            recipient: {
                                country_code: countryCode,
                                state_code: stateCode
                            },
                            items: [{
                                variant_id: parseInt(variantId),
                                quantity: 1
                            }]
                        }
                    })
                });
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }

        // Event Listeners
        document.getElementById('fetch-products-btn').addEventListener('click', async () => {
            const resultDiv = document.getElementById('products-result');
            resultDiv.innerHTML = '<p class="text-blue-600">Loading products...</p>';
            
            try {
                const data = await fetchProducts();
                if (data.success) {
                    const products = data.products || [];
                    resultDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                            <p class="text-green-800 font-semibold">✓ Successfully fetched ${products.length} products</p>
                        </div>
                        <div class="max-h-96 overflow-y-auto">
                            <pre class="bg-gray-100 p-4 rounded-lg text-xs overflow-auto">${JSON.stringify(products.slice(0, 3), null, 2)}</pre>
                            <p class="text-sm text-gray-600 mt-2">Showing first 3 products. Check console for full data.</p>
                        </div>
                    `;
                    console.log('All products:', products);
                } else {
                    resultDiv.innerHTML = `<p class="text-red-600">Error: ${data.error || 'Unknown error'}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-600">Error: ${error.message}</p>`;
            }
        });

        document.getElementById('create-mockup-btn').addEventListener('click', async () => {
            const variantId = document.getElementById('variant-id').value;
            const imageUrl = document.getElementById('image-url').value;
            const resultDiv = document.getElementById('mockup-result');
            
            if (!variantId || !imageUrl) {
                resultDiv.innerHTML = '<p class="text-red-600">Please fill in both fields</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p class="text-blue-600">Creating mockup task...</p>';
            
            try {
                const data = await createMockup(variantId, imageUrl);
                if (data.success && data.task_key) {
                    resultDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                            <p class="text-green-800 font-semibold">✓ Mockup task created!</p>
                            <p class="text-sm text-gray-700 mt-2">Task Key: <code class="bg-white px-2 py-1 rounded">${data.task_key}</code></p>
                        </div>
                        <p class="text-blue-600">Polling for mockup status...</p>
                    `;
                    
                    // Poll for mockup status
                    const pollMockup = async () => {
                        try {
                            const statusData = await getMockupStatus(data.task_key);
                            if (statusData.success && statusData.task) {
                                if (statusData.task.status === 'completed') {
                                    const mockups = statusData.task.mockups || [];
                                    let html = '<div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">';
                                    html += '<p class="text-green-800 font-semibold mb-4">✓ Mockup ready!</p>';
                                    mockups.forEach(mockup => {
                                        html += `<div class="mb-4"><img src="${mockup.url}" alt="Mockup" class="max-w-full rounded-lg shadow-md"></div>`;
                                    });
                                    html += '</div>';
                                    resultDiv.innerHTML = html;
                                } else {
                                    resultDiv.innerHTML = `<p class="text-blue-600">Status: ${statusData.task.status}. Checking again in 2 seconds...</p>`;
                                    setTimeout(pollMockup, 2000);
                                }
                            }
                        } catch (error) {
                            resultDiv.innerHTML = `<p class="text-red-600">Error checking status: ${error.message}</p>`;
                        }
                    };
                    
                    setTimeout(pollMockup, 2000);
                } else {
                    resultDiv.innerHTML = `<p class="text-red-600">Error: ${data.error || 'Unknown error'}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-600">Error: ${error.message}</p>`;
            }
        });

        document.getElementById('estimate-shipping-btn').addEventListener('click', async () => {
            const countryCode = document.getElementById('country-code').value;
            const stateCode = document.getElementById('state-code').value;
            const variantId = document.getElementById('shipping-variant-id').value;
            const resultDiv = document.getElementById('shipping-result');
            
            if (!countryCode || !variantId) {
                resultDiv.innerHTML = '<p class="text-red-600">Please fill in country code and variant ID</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p class="text-blue-600">Estimating shipping...</p>';
            
            try {
                const data = await estimateShipping(countryCode, stateCode, variantId);
                if (data.success && data.rates) {
                    const rates = data.rates;
                    let html = '<div class="bg-green-50 border border-green-200 rounded-lg p-4">';
                    html += '<p class="text-green-800 font-semibold mb-4">✓ Shipping rates:</p>';
                    html += '<div class="space-y-2">';
                    rates.forEach(rate => {
                        html += `
                            <div class="bg-white p-3 rounded border">
                                <p class="font-semibold">${rate.name}</p>
                                <p class="text-gray-600">$${rate.rate} - ${rate.estimated_days} days</p>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<p class="text-red-600">Error: ${data.error || 'Unknown error'}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-600">Error: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>

